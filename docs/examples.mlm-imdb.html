---

title: Masked Language Modeling


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/11_examples.mlm-imdb.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/11_examples.mlm-imdb.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">AutoModelForMaskedLM</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span><span class="p">,</span> <span class="n">concatenate_datasets</span>

<span class="kn">from</span> <span class="nn">fastai.text.all</span> <span class="kn">import</span> <span class="n">DataBlock</span><span class="p">,</span> <span class="n">IndexSplitter</span><span class="p">,</span> <span class="n">noop</span><span class="p">,</span> <span class="n">perplexity</span>
<span class="kn">from</span> <span class="nn">fasthugs.learner</span> <span class="kn">import</span> <span class="n">TransLearner</span>
<span class="kn">from</span> <span class="nn">fasthugs.data</span> <span class="kn">import</span> <span class="n">TransformersLMBlock</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;distilroberta-base&#39;</span>
<span class="c1"># data</span>
<span class="n">max_length</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">bs</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">val_bs</span> <span class="o">=</span> <span class="n">bs</span><span class="o">*</span><span class="mi">4</span>
<span class="c1"># training</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">3e-5</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Data-preprocessing">Data preprocessing<a class="anchor-link" href="#Data-preprocessing"> </a></h2><p>In this example notebook we use HuggingFace datasets for preprocessing (as show in example notebook <a href="https://github.com/huggingface/notebooks/blob/master/examples/language_modeling.ipynb">here</a>).</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ds_name</span> <span class="o">=</span> <span class="s1">&#39;imdb&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">ds_name</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Reusing dataset imdb (/root/.cache/huggingface/datasets/imdb/plain_text/1.0.0/4ea52f2e58a08dbc12c2bd52d0d92b30b88c00230b4522801b3636782f625c5b)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2000</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span><span class="o">.</span><span class="n">column_names</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;label&#39;, &#39;text&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="n">return_attention_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_special_tokens_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">task_templates</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">tokenize</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">remove_columns</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">column_names</span><span class="p">,</span> <span class="n">num_proc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>



</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">block_size</span> <span class="o">=</span> <span class="n">max_length</span>

<span class="k">def</span> <span class="nf">group_texts</span><span class="p">(</span><span class="n">examples</span><span class="p">):</span>
    <span class="c1"># Concatenate all texts.</span>
    <span class="n">concatenated_examples</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">examples</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">examples</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">total_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">concatenated_examples</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">examples</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="c1"># We drop the small remainder, we could add padding if the model supported it instead of this drop, you can</span>
        <span class="c1"># customize this part to your needs.</span>
    <span class="n">total_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_length</span> <span class="o">//</span> <span class="n">block_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_size</span>
    <span class="c1"># Split by chunks of max_len.</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">block_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_length</span><span class="p">,</span> <span class="n">block_size</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">concatenated_examples</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lm_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
    <span class="n">group_texts</span><span class="p">,</span>
    <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">num_proc</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>



</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Training">Training<a class="anchor-link" href="#Training"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lm_dataset</span><span class="p">)</span>
<span class="n">idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
<span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">split</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">train_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:</span><span class="n">split</span><span class="p">]</span>
<span class="n">valid_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">split</span><span class="p">:]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dblock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="p">[</span><span class="n">TransformersLMBlock</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">)],</span>
                   <span class="n">splitter</span><span class="o">=</span><span class="n">IndexSplitter</span><span class="p">(</span><span class="n">valid_idx</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">dblock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">lm_dataset</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">val_bs</span><span class="o">=</span><span class="n">val_bs</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>daughter. Richard Conte of "The Godfather"&lt;mask&gt; a Sicilian crime boss who wants to bury the hatchet with the Delon character, but&lt;mask&gt; rest of his hard-n&lt;mask&gt; associates want the hit-&lt;mask&gt; dead. Like most crime thrillers in the 1960s and&lt;mask&gt;&lt;mask&gt;, "Big Guns" subscribes to the cinematic morality&lt;mask&gt; crime does not pay. Interestingly, the one man who has nothing to do with the murder of the wife and son&lt;mask&gt;&lt;mask&gt; hero survives while another&lt;mask&gt;rays the hero&lt;mask&gt; extreme prejudice.&lt;mask&gt;ari does not waste a second in this 90-minute shoot&lt;mask&gt;em up. Apart from the</td>
    </tr>
    <tr>
      <th>1</th>
      <td>This is by far the best triple Madness match i have&lt;mask&gt; seen. It had close falls&lt;mask&gt; plenty of finishers, stolen fin&lt;mask&gt;, raw energy, intensity and fast pace. No one could&lt;mask&gt; who would&lt;mask&gt; out&lt;mask&gt; this one. If your going to buy this&lt;mask&gt;&lt;mask&gt;&lt;mask&gt;iphany it strictly for this match. (ending&lt;mask&gt; watch for yourself!)&lt;br /&gt;&lt;br stabilizedOverall&lt;mask&gt; was a solid&lt;mask&gt;V&lt;mask&gt; plenty&lt;mask&gt; extra goodies&lt;mask&gt; keep you watching again and again. Although this is hard to&lt;mask&gt; (&lt;mask&gt; had to pay a little more than usual for this&lt;mask&gt;) it&lt;mask&gt; definitely worth your money.&lt;/s&gt;&lt;s&gt;This&lt;mask&gt;</td>
    </tr>
    <tr>
      <th>2</th>
      <td>.&lt;mask&gt; Eye really shows his skills at storytelling.&lt;br /&gt;&lt;br /&gt;Red Eye also works&lt;mask&gt; because of its young&lt;mask&gt; talented cast. Rachel McAdams gives a very engaging performance and&lt;mask&gt; character&lt;mask&gt; hard to hate&lt;mask&gt; You may even end up&lt;mask&gt; for her out loud. Cillian&lt;mask&gt; gives a very creepy and&lt;mask&gt; performance as theottest. The way he acts charming at first but&lt;mask&gt; turns psycho is especially&lt;mask&gt;. The supporting actors are also pretty good&lt;mask&gt; include Brain Cox and Jay&lt;mask&gt; Mays.&lt;br /&gt;&lt;br /&gt;The&lt;mask&gt; is&lt;mask&gt; very&lt;mask&gt; and it has this overall creepy vibe to it. The setting works well since there</td>
    </tr>
    <tr>
      <th>3</th>
      <td>learns that Tony is actually part of two families&lt;mask&gt; in one family&lt;mask&gt; is a loving father yet not-so-perfect&lt;mask&gt;husband, and in the other family he is a ruthless wiseguy&lt;mask&gt; After analysis, Dr. Melfi concludes that Tony's problems actually derive from his mother L&lt;mask&gt;, who's&lt;mask&gt; to have borderline&lt;mask&gt;personality disorder. Gandolfini is rightfully praised&lt;mask&gt; the main character; yet Bracco and March&lt;mask&gt; aren't nearly as recognized for their equally and talented performances as the psychiatrist and mother, respectively. Falco, Imperioli and De&lt;mask&gt;te&lt;mask&gt; are acclaimed for their brilliant supporting roles&lt;mask&gt; Van Zand</td>
    </tr>
    <tr>
      <th>4</th>
      <td>past, we have always simply branded killers "psychopaths" and assumed that&lt;mask&gt; they were biologically wired for disaster or had media influence, but as Zero Day shows sometimes the motives are deeper than that, and we can never&lt;mask&gt; understand why tragedies such&lt;mask&gt;&lt;mask&gt; shootings&lt;mask&gt; until we have seen it from&lt;mask&gt; perspective of the killers.&lt;/s&gt;&lt;s&gt;I rented Zero Day from the local video store last&lt;mask&gt;.&lt;mask&gt; had never heard of the film and I had my reservations about&lt;mask&gt;.&lt;mask&gt; from looking at the box I knew the film&lt;mask&gt; an Indie film&lt;mask&gt; therefore the quality was&lt;mask&gt; to be less than a mainstream film. &lt;&lt;mask&gt;&lt;mask&gt;&gt;&lt;br</td>
    </tr>
    <tr>
      <th>5</th>
      <td>telling.&lt;br /&gt;&lt;br /&gt;The other direct&lt;mask&gt;&lt;mask&gt; the Pulp Magazine. The inexpensive&lt;mask&gt; prose story publications that carried a great deal of&lt;mask&gt; of the same deposits characters&lt;mask&gt; on going, though not necessarily serialized, tales. The&lt;mask&gt; medium had&lt;mask&gt; around&lt;mask&gt;&lt;mask&gt; decades and introduced us to Edgar Rice Borrough's TAR&lt;mask&gt;AN and Johnston McCulley's ZORRO&lt;mask&gt; The 1930's brought&lt;mask&gt; a bumper crop as feature characters&lt;mask&gt; THE SHADOW, THE AVENGER, G8's BATTLE&lt;mask&gt;ES and THE SPIDER,MASTER of MEN all found their way to the news stands&lt;mask&gt; among many</td>
    </tr>
    <tr>
      <th>6</th>
      <td>his obsessive compulsive cleaning sprees and&lt;mask&gt; phobias and sends her a suicide telegram.Sheipient Oscar and&lt;mask&gt; him know what happened.Felix turns up at Oscar's during his weekly poker game with&lt;mask&gt; friends Vinnie(John Fielder)&lt;mask&gt; the policeman(&lt;mask&gt;bert Edelman)Roy(David Sheiner)and Speed(Larry Haines).After some side splitting&lt;mask&gt;ics&lt;mask&gt;'s agreed Felix will&lt;mask&gt; gib Oscar.&lt;br /&gt;&lt;br /&gt;The rest of the film centres on how theseULT are such completely different characters.As well as looking at if Oscar&lt;mask&gt;&lt;mask&gt;&lt;mask&gt;'s truly weird and unique habits and</td>
    </tr>
    <tr>
      <th>7</th>
      <td>/&gt;No one&lt;mask&gt; naturally disturbed but ultimately intrigued about the nightmarish&lt;mask&gt; of Pete being abducted and sexually abused for years until he was&lt;mask&gt; rescued&lt;mask&gt; a&lt;mask&gt; named Donna (Collette giving an excellent performance) who has adopted the boy but her correspondence with No&lt;mask&gt; reveals that&lt;mask&gt; is&lt;mask&gt; from AIDS.&lt;mask&gt; No&lt;mask&gt; wants&lt;mask&gt; meet the fans but is suddenly in doubt to their possibly devious ulterior motives when the seed is planted by&lt;mask&gt; estranged lover&lt;mask&gt; (Cannavale) whose sudden departure from their New York City apartment&lt;mask&gt; No one in an emotional tailspin that has only now grown into a temp&lt;mask&gt; in a&lt;mask&gt;ac</td>
    </tr>
    <tr>
      <th>8</th>
      <td>&lt;mask&gt; even though the script does leave a lot of room for&lt;mask&gt;. Most laughs&lt;mask&gt; from the difference between&lt;mask&gt;vira and the people of good morals, but there are a couple of good visual&lt;mask&gt;ags as well.&lt;mask&gt; all direction is&lt;mask&gt;, but it never&lt;mask&gt; to&lt;mask&gt; anything more than that. In all, a good, intentionally campy,&lt;mask&gt;. If you like this&lt;mask&gt;&lt;mask&gt; thing, that is.&lt;/s&gt;&lt;s&gt;I found&lt;mask&gt; episode to be one of funniest&lt;mask&gt;'ve seen in a long time&lt;mask&gt;&lt;mask&gt;&lt;mask&gt; park creators have done the best spoof&lt;mask&gt;&lt;mask&gt; Romero&lt;mask&gt; I have ever seen.They have truly touched on Romero</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;input_ids&#39;</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor([[ 3809, 48709,   100,  ...,  1250,     8, 50264],
         [   31, 50264, 27499,  ...,    10,  9209, 15259],
         [    4,   653,    38,  ...,     7,   224,    14],
         ...,
         [    5, 46646, 31794,  ...,     5,   527,     8],
         [50264, 25477,     7,  ...,    59,   657, 50264],
         [   85, 50264, 50264,  ...,    65,     9,    39]]),
 tensor([[-100, -100, -100,  ..., -100, -100, 5905],
         [-100,    5, -100,  ..., -100, -100, -100],
         [-100, -100, -100,  ..., -100,  224, -100],
         ...,
         [-100, -100, -100,  ..., -100, -100, -100],
         [1256, -100, -100,  ..., -100, -100,    6],
         [-100,   18,   99,  ..., -100, -100, -100]]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The labels are constructed by <code>DataCollatorForLanguageModeling</code> and the loss computed by the model is used for training.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForMaskedLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">TransLearner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">loss_func</span><span class="o">=</span><span class="n">noop</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">perplexity</span><span class="p">)</span><span class="o">.</span><span class="n">to_fp16</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As masking is done randomly on the fly, validation score may vary.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#2) [2.9136292934417725,18.423542022705078]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_flat_cos</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">3e-5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>perplexity</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2.392086</td>
      <td>2.245003</td>
      <td>9.440444</td>
      <td>01:36</td>
    </tr>
    <tr>
      <td>1</td>
      <td>2.307463</td>
      <td>2.124191</td>
      <td>8.366127</td>
      <td>01:39</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#2) [2.1733407974243164,8.787592887878418]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

