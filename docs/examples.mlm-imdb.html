---

title: Title


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/11_examples.mlm-imdb.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/11_examples.mlm-imdb.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="k">if</span> <span class="s1">&#39;google.colab&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
    <span class="o">!</span>pip install -Uqq fastcore sentencepiece
    <span class="o">!</span>pip install -Uqq --no-deps fastai
    <span class="o">!</span>pip install -Uqq transformers datasets wandb
    <span class="o">!</span>pip install git+git://github.com/aikindergarten/fasthugs.git
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="k">import</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">AutoModelForMaskedLM</span>
<span class="c1">#                           DataCollatorForLanguageModeling,</span>
<span class="c1">#                           DataCollatorForWholeWordMask)</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="k">import</span> <span class="n">load_dataset</span><span class="p">,</span> <span class="n">concatenate_datasets</span><span class="p">,</span> <span class="n">load_metric</span>

<span class="kn">from</span> <span class="nn">fastai.text.all</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fasthugs.learner</span> <span class="k">import</span> <span class="n">TransLearner</span>
<span class="kn">from</span> <span class="nn">fasthugs.data</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;distilroberta-base&#39;</span>
<span class="c1"># data</span>
<span class="n">max_length</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">bs</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">val_bs</span> <span class="o">=</span> <span class="n">bs</span><span class="o">*</span><span class="mi">4</span>
<span class="c1"># training</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">3e-5</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Data-preprocessing">Data preprocessing<a class="anchor-link" href="#Data-preprocessing"> </a></h2><p>In this example notebook we use HuggingFace datasets for preprocessing (as show in example <a href="">here</a>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ds_name</span> <span class="o">=</span> <span class="s1">&#39;imdb&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">ds_name</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Reusing dataset imdb (/root/.cache/huggingface/datasets/imdb/plain_text/1.0.0/4ea52f2e58a08dbc12c2bd52d0d92b30b88c00230b4522801b3636782f625c5b)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2000</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span><span class="o">.</span><span class="n">column_names</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;label&#39;, &#39;text&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="n">return_attention_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_special_tokens_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">tokenize</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">remove_columns</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">column_names</span><span class="p">,</span> <span class="n">num_proc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>



</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">block_size</span> <span class="o">=</span> <span class="n">max_length</span>

<span class="k">def</span> <span class="nf">group_texts</span><span class="p">(</span><span class="n">examples</span><span class="p">):</span>
    <span class="c1"># Concatenate all texts.</span>
    <span class="n">concatenated_examples</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">examples</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">examples</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">total_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">concatenated_examples</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">examples</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="c1"># We drop the small remainder, we could add padding if the model supported it instead of this drop, you can</span>
        <span class="c1"># customize this part to your needs.</span>
    <span class="n">total_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_length</span> <span class="o">//</span> <span class="n">block_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_size</span>
    <span class="c1"># Split by chunks of max_len.</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">block_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_length</span><span class="p">,</span> <span class="n">block_size</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">concatenated_examples</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lm_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
    <span class="n">group_texts</span><span class="p">,</span>
    <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">num_proc</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>



</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Training">Training<a class="anchor-link" href="#Training"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForMaskedLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lm_dataset</span><span class="p">)</span>
<span class="n">idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
<span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">split</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">train_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:</span><span class="n">split</span><span class="p">]</span>
<span class="n">valid_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">split</span><span class="p">:]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dblock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="p">[</span><span class="n">TransformersLMBlock</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">)],</span>
                   <span class="n">splitter</span><span class="o">=</span><span class="n">IndexSplitter</span><span class="p">(</span><span class="n">valid_idx</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">dblock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">lm_dataset</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">val_bs</span><span class="o">=</span><span class="n">val_bs</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>routine for an metaph audience. Then ten or twelve comics are selected to live&lt;mask&gt;&lt;mask&gt; house&lt;mask&gt; and do "Surviv&lt;mask&gt;" style competitions using comedic tactics.&lt;mask&gt; one will&lt;mask&gt; determined as "Last Comic Standing." I dowid&lt;mask&gt; up comedy, so boldly is the one&lt;mask&gt; show must&lt;mask&gt; to my&lt;mask&gt;.&lt;mask&gt; are usually some&lt;mask&gt; funny comics&lt;mask&gt; through. It&lt;mask&gt;&lt;mask&gt;&lt;mask&gt; of such talents as&lt;mask&gt;&lt;mask&gt;zo&lt;mask&gt;odden, Ralphie Silk,&lt;mask&gt; Josh Blue.&lt;br /&gt;&lt;br /&gt;My negative criticisms is the&lt;mask&gt; that there is the possibility that a lot of these comics were selected for their contribution to reality show drama.</td>
    </tr>
    <tr>
      <th>1</th>
      <td>have gotten&lt;mask&gt; attention while it was being aired, it was definitely an original and very special&lt;mask&gt; that should have&lt;mask&gt; appreciated much more than it was.&lt;/s&gt;&lt;s&gt;This&lt;mask&gt;&lt;mask&gt; as&lt;mask&gt; once was and comparing this with the two remakes, THE MONEY PIT and ARE WE DONE YET?,&lt;mask&gt; points out all the more how the 40's movie makers had a&lt;mask&gt; for comedy which has since&lt;mask&gt; regretfully,&lt;mask&gt; lost.&lt;br /&gt;&lt;br /&gt;I was 15 when I first saw&lt;mask&gt; and even at that tender age, there was much I could laugh at.&lt;mask&gt; of&lt;mask&gt; being familiar&lt;mask&gt; adult frustrations, I see&lt;mask&gt; whole</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Sep. 11&lt;mask&gt;, I thought to myself "It's OK, the policemen and firemen&lt;mask&gt;&lt;mask&gt; the people out that&lt;mask&gt;". To&lt;mask&gt; honest, I&lt;mask&gt; it was an&lt;mask&gt;&lt;mask&gt;&lt;mask&gt; was in&lt;mask&gt;&lt;mask&gt; year of high orally and getting changed from gym and getting ready&lt;mask&gt; go to my&lt;mask&gt; class. Someone came into&lt;mask&gt; locker room shouting "Some building just got bombed in New York!", we all got dressed quickly&lt;mask&gt; ran to our classrooms as we watched the first tower burning on&lt;mask&gt;. Not only&lt;mask&gt; seconds later live on TV does the&lt;mask&gt; plane&lt;mask&gt; into the other World Trade Center and we&lt;mask&gt; this was&lt;mask&gt; accident.&lt;mask&gt; few</td>
    </tr>
    <tr>
      <th>3</th>
      <td>seems&lt;mask&gt; work someway, but is deeply flawed and influenced by events. The&lt;mask&gt; character played by the director is a playwright whose mid-life personal and creative crisis is amplified by&lt;mask&gt; pressure of the events and&lt;mask&gt; the fact that he&lt;mask&gt; lucky enough to leave&lt;mask&gt; terror attack&lt;mask&gt;&lt;mask&gt;&lt;mask&gt; the bomb explodes. He hires a private detective to follow his girlfriend who is a TV investigative reporter whom he suspects is falling in for the subject&lt;mask&gt; her next show - another failed man, former military, whose business and family life&lt;mask&gt;les under the events. He starts to write a play that carbon-copies the reality and will bring it to</td>
    </tr>
    <tr>
      <th>4</th>
      <td>aha, well, yes&lt;mask&gt; i don't think a movie with prematurely budget like this could afford "good" actors or effects so they worked with what they had. the guts and entrails were actually very convincing&lt;mask&gt;&lt;mask&gt; movie&lt;mask&gt; a little&lt;mask&gt;ppy going from sequence to sequence but overall, this is one of the better movies i have seen lately that&lt;mask&gt;'t follow any&lt;mask&gt; or predictability&lt;mask&gt; very goodished a laugh&lt;mask&gt;&lt;/s&gt;&lt;s&gt;Well this&lt;mask&gt; was probobly one of the funniest scary movie i have ever seen. The effects are so bad you just have to laugh&lt;mask&gt;&lt;mask&gt;&lt;mask&gt; acting, well lets say its no mel</td>
    </tr>
    <tr>
      <th>5</th>
      <td>&lt;mask&gt; the&lt;mask&gt;&lt;mask&gt; framed in decorated moving triangles or circles. Trans&lt;mask&gt; are filled with&lt;mask&gt;, and Celtic knots.&lt;mask&gt; the trees to the floors, many things in this world are&lt;mask&gt; in shapes or&lt;mask&gt;.&lt;br /ï¿½br /&gt;Clocking in&lt;mask&gt; 70Na minus credits, The Secret of Kells is a fun little history lesson with a little&lt;mask&gt; and silliness thrown in to keep&lt;mask&gt; (maybe just&lt;mask&gt;) exped. I&lt;mask&gt; one has to generally be open-&lt;mask&gt;&lt;mask&gt; to The Secret of Kells as half art piece, half movie about history.&lt;mask&gt; looking&lt;mask&gt; it was animated with Adobe illustrator, It's a very</td>
    </tr>
    <tr>
      <th>6</th>
      <td>&lt;mask&gt; wounded&lt;mask&gt; manages to set fire to a gas&lt;mask&gt;, providing a perfect target for his fellow bombard&lt;mask&gt;. Stylistically, Bomb&lt;mask&gt;ier is&lt;mask&gt; of the most schizophrenic of war films, with moments of subtle poignancy (the death&lt;mask&gt; trainee Eddie Albert) alternating with scenes of ludicrous "Yellow Peril" melodrama (the Japanese&lt;mask&gt; hiss through their teeth as&lt;mask&gt; torture the helpless&lt;mask&gt;). Though it can't help but seem&lt;mask&gt; today,&lt;mask&gt;ard constituents remains an&lt;mask&gt; propaganda effort (&lt;mask&gt; film&lt;mask&gt; sometimes erroneously&lt;mask&gt; as the debut of Robert Ryan, who'd actually been appearing&lt;mask&gt; the cameras since 1940</td>
    </tr>
    <tr>
      <th>7</th>
      <td>,&lt;mask&gt; so doing, reveals a lot about the reporter's character.) &lt;br&lt;mask&gt;&lt;mask&gt;&lt;mask&gt; /&gt;Firefall&lt;mask&gt; this episode appears to have a bad reputation among fans, but I enjoyed it because it's got a great&lt;mask&gt; herring and a really creepy, almost unstoppable-seeming monster.&lt;br&lt;mask&gt;&lt;mask&gt;br&lt;mask&gt;Though I've singled&lt;mask&gt; these three&lt;mask&gt; for praise, I'd say that most of the stories are entertaining at the very least. For my money,&lt;mask&gt; are only&lt;mask&gt; complete turkeys in the 20-&lt;mask&gt; run: Primal Scream, which is about monkey-men running rampant in Chicago, and&lt;mask&gt; Sentry, which</td>
    </tr>
    <tr>
      <th>8</th>
      <td>be resisted, that&lt;mask&gt; just who we are.&lt;br /&gt;&lt;br /&gt;There is a consistent&lt;mask&gt;ness from start to finish century&lt;mask&gt; photography&lt;mask&gt; sharp composition,&lt;mask&gt; pleasant&lt;mask&gt; when&lt;mask&gt;&lt;mask&gt; provocative content, well suited music and laugh out loud scripting.&lt;br /&gt;&lt;br /&gt;&lt;mask&gt; out for the very young "lone wise voice"... brilliant&lt;mask&gt; wisdom&lt;mask&gt; innocence balancing comedy from the human condition.&lt;/s&gt;&lt;s&gt;This is one ofRepresent unfortunate films that&lt;mask&gt; an even more sad, unfortunate&lt;mask&gt; at the box office. I saw this&lt;mask&gt; at a local art cinema,in revival form,shortly after it tanked in&lt;mask&gt; cinemas. It</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">b</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>({&#39;attention_mask&#39;: tensor([[1, 1, 1,  ..., 1, 1, 1],
         [1, 1, 1,  ..., 1, 1, 1],
         [1, 1, 1,  ..., 1, 1, 1],
         ...,
         [1, 1, 1,  ..., 1, 1, 1],
         [1, 1, 1,  ..., 1, 1, 1],
         [1, 1, 1,  ..., 1, 1, 1]]), &#39;input_ids&#39;: tensor([[   95,    10,   828,  ...,  1183,   143,  3238],
         [    8,   841,   116,  ...,  1589, 49007,  3809],
         [   80,   664, 50264,  ...,     9,   256,  2459],
         ...,
         [    7,   120,    69,  ...,    31, 50264, 27942],
         [   21, 50264, 50264,  ...,   843, 50264, 17768],
         [ 3121,  4558,    53,  ...,   747,  6269,     6]]), &#39;labels&#39;: tensor([[ -100,  -100,  -100,  ...,  -100,  -100,  -100],
         [ -100,  -100,  -100,  ...,  -100,  -100,  -100],
         [ -100,  -100, 13148,  ...,  -100,  -100,  -100],
         ...,
         [ -100,  -100,  -100,  ...,  -100,     5,  -100],
         [ -100,    14,    24,  ...,  -100,    29,     8],
         [ -100,  -100,  -100,  ...,  -100,  -100,  -100]])},)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The labels are constructed by <code>DataCollatorForLanguageModeling</code> and the loss computed by the model is used for training.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">TransLearner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">loss_func</span><span class="o">=</span><span class="n">noop</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">perplexity</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As masking is done randomly on the fly, validation score may vary.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#2) [2.126232862472534,8.38322639465332]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_flat_cos</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">3e-5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>perplexity</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2.381680</td>
      <td>2.202039</td>
      <td>9.043432</td>
      <td>03:40</td>
    </tr>
    <tr>
      <td>1</td>
      <td>2.275901</td>
      <td>2.131905</td>
      <td>8.430911</td>
      <td>03:41</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

