---

title: Multiple Choice


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/16_examples.multiple_choice.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/16_examples.multiple_choice.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ds_name</span> <span class="o">=</span> <span class="s2">&quot;swag&quot;</span>
<span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;google/electra-base-discriminator&quot;</span>

<span class="n">max_len</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">bs</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">val_bs</span> <span class="o">=</span> <span class="n">bs</span><span class="o">*</span><span class="mi">2</span>

<span class="n">lr</span> <span class="o">=</span> <span class="mf">3e-5</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">ds_name</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">)</span>
<span class="c1"># train_ds = load_dataset(ds_name, &quot;regular&quot;, split=&#39;validation&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dataloaders">Dataloaders<a class="anchor-link" href="#Dataloaders"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">splits</span> <span class="o">=</span> <span class="n">get_splits</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">concatenate_datasets</span><span class="p">([</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">],</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;validation&#39;</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;ending0&#39;: &#39;passes by walking down the street playing their instruments.&#39;,
 &#39;ending1&#39;: &#39;has heard approaching them.&#39;,
 &#39;ending2&#39;: &#34;arrives and they&#39;re outside dancing and asleep.&#34;,
 &#39;ending3&#39;: &#39;turns the lead singer watches the performance.&#39;,
 &#39;fold-ind&#39;: &#39;3416&#39;,
 &#39;gold-source&#39;: &#39;gold&#39;,
 &#39;label&#39;: 0,
 &#39;sent1&#39;: &#39;Members of the procession walk down the street holding small horn brass instruments.&#39;,
 &#39;sent2&#39;: &#39;A drum line&#39;,
 &#39;startphrase&#39;: &#39;Members of the procession walk down the street holding small horn brass instruments. A drum line&#39;,
 &#39;video-id&#39;: &#39;anetv_jkn6uvmqwh4&#39;}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">text_fields</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;sent1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sent2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ending0&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ending1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ending2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ending3&#39;</span>
    <span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dblock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">MultiChoiceBlock</span><span class="p">(</span><span class="n">text_fields</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">text_fields</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">pretrained_model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">),</span>
              <span class="n">CategoryBlock</span><span class="p">()],</span>
    <span class="n">get_x</span><span class="o">=</span><span class="n">KeyGetter</span><span class="p">(</span><span class="n">text_fields</span><span class="p">),</span>
    <span class="n">get_y</span><span class="o">=</span><span class="n">ItemGetter</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">),</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">IndexSplitter</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">dblock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">val_bs</span><span class="o">=</span><span class="n">val_bs</span><span class="p">,</span> <span class="n">num_workes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 1min 1s, sys: 2.41 s, total: 1min 3s
Wall time: 1min 2s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The inputs are shape as <code>bs x n_choices x seq_len</code>:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([16, 4, 65])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">max_n</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sent1</th>
      <th>ending0</th>
      <th>ending1</th>
      <th>ending2</th>
      <th>ending3</th>
      <th>category</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>members of the procession walk down the street holding small horn brass instruments.</td>
      <td>a drum line passes by walking down the street playing their instruments.</td>
      <td>a drum line has heard approaching them.</td>
      <td>a drum line arrives and they're outside dancing and asleep.</td>
      <td>a drum line turns the lead singer watches the performance.</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>a chain is wrapped around a tree stump.</td>
      <td>a man looks at him on the ground.</td>
      <td>a man uses the tool to wrap the ink off the tree.</td>
      <td>a man is lifted into the tree.</td>
      <td>a man holds the roof of the terraced house.</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>someone appears to remind someone of her appointment.</td>
      <td>someone stays behind for another moment.</td>
      <td>someone leans down and places his hand on her lower back.</td>
      <td>someone pitches a billy bag with a pie.</td>
      <td>someone shoots shafts of light into someone's face.</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>father and daughter go into their flat.</td>
      <td>the daughter sprays buckets on her head, slides tension into the upper corner of the apartment.</td>
      <td>the daughter feeds him phone.</td>
      <td>the daughter subdues a smile at her feet.</td>
      <td>the daughter peeps back out and waves.</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">reinit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s2">&quot;fasthugs&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="s2">&quot;fastai_community&quot;</span><span class="p">,</span>
           <span class="n">name</span><span class="o">=</span><span class="n">WANDB_NAME</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">GROUP</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="n">NOTES</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">TAGS</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Training">Training<a class="anchor-link" href="#Training"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForMultipleChoice</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">TransLearner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The final layers of the model are initialized with random weights, we can varufy that the performance is as good as random choice:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#2) [1.3858414888381958,0.2647205889225006]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">WandbCallback</span><span class="p">(</span><span class="n">log_preds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log_model</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Could not gather input dimensions
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.605681</td>
      <td>0.375084</td>
      <td>0.857193</td>
      <td>52:49</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.401334</td>
      <td>0.316267</td>
      <td>0.882435</td>
      <td>52:49</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sent1</th>
      <th>ending0</th>
      <th>ending1</th>
      <th>ending2</th>
      <th>ending3</th>
      <th>category</th>
      <th>category_</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>students lower their eyes nervously.</td>
      <td>she pats her shoulder, then saunters toward someone.</td>
      <td>she turns with two students.</td>
      <td>she walks slowly towards someone.</td>
      <td>she wheels around as her dog thunders out.</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>as somone charges, he delivers a mighty upward blow.</td>
      <td>spraying blood gushes through the giant.</td>
      <td>spraying blood, he lies on a floor that bears the silverware and treatment.</td>
      <td>spraying blood soaks half his face.</td>
      <td>spraying blood from someone's leg, someone swings him back down.</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>the player runs past the first base.</td>
      <td>the player then serves the ball with the invite.</td>
      <td>the player then comes back to the first base and puts his foot on it.</td>
      <td>the player then shows on it for a second and then throws it on the field.</td>
      <td>the player then hits one and turns back with the shield.</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>when they are done, they hold hands as the crowd cheers.</td>
      <td>they continue drumming with each other while people cheer for the match.</td>
      <td>they walk over to the woman in a green dress, hugging her before leaving the stage.</td>
      <td>they look into the dance screen and continue to play.</td>
      <td>they do a routine on the platform.</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>the woman hold the center of the plastic.</td>
      <td>the woman positions the carpet with a squeegee.</td>
      <td>the woman puts the woman's fingers in the cutting pin, and the woman puts the black dot on the finger.</td>
      <td>the woman uses a piece of steel on the rope.</td>
      <td>the woman tied the ribbon on the wrapper and cut the excess ribbon.</td>
      <td>3</td>
      <td>3</td>
    </tr>
    <tr>
      <th>5</th>
      <td>he runs fast fast down the strip and quickly leaps into the sand.</td>
      <td>then he runs all over the room and runs, almost rolling one foot after another.</td>
      <td>then he runs off the road and getting excited.</td>
      <td>then he follows current movements before leaving only the other corporate breathless.</td>
      <td>then he goes back to start over and does it a few more times.</td>
      <td>3</td>
      <td>3</td>
    </tr>
    <tr>
      <th>6</th>
      <td>someone follows someone into the leeds dressing room.</td>
      <td>someone notes on an just nearby cabinet feature, its shadows at its sides.</td>
      <td>someone takes a note from his blazer pocket.</td>
      <td>someone smiles, who stares forward, horrified.</td>
      <td>someone crosses to a small waiting cafe where its left door stands.</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>7</th>
      <td>once she is on, she begins kicking her legs up and down and doing several flips along the bar.</td>
      <td>for her final trick, she flips off the bar and her foot goes further than expected but she steps into the ropes.</td>
      <td>for her final trick, she flips off the bar and her foot goes further than expected but she barely jumps up into the acetone net.</td>
      <td>for her final trick, she flips off the bar and her foot goes further than expected but she quickly gathers herself and sticks her landing.</td>
      <td>for her final trick, she flips off the bar and her foot goes further than expected but she flops on a board multiple times.</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>8</th>
      <td>the club owner affords a slight nod.</td>
      <td>now someone rubs her hands over her head and body.</td>
      <td>now someone draws a white frozen mirror.</td>
      <td>now someone opens a stairwell as someone shuffles layering creamy fluid.</td>
      <td>now someone pulls a sausage out of a large bottle on the stairs.</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

